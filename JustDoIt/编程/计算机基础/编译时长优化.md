## 编译过程

![](https://raw.githubusercontent.com/BlairRenaissance/ImageHost/main/Clipboard_Screenshot_1738812659.png)

## 渲染引擎编译耗时分析

通过 xcode 编译追踪，可以看出编译过程最长的模块为： GLMapLibBusiness (工具: xclogparser)

![](https://raw.githubusercontent.com/BlairRenaissance/ImageHost/main/20250206112448.png)


耗时最长的几个编译文件，从中找出了一个行数不多，但编译时间很长的文件: MapNerdTile.cc

![](https://raw.githubusercontent.com/BlairRenaissance/ImageHost/main/20250206112715.png)

## 如何精简头文件引用

### 原则1. 头文件只导出自己相关的最小集合

| **BAD**                                                                                                                                                                                                                                                                         | **GOOD**                                                                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `#program once`<br>`#include "a.h"` <br>`#include "useless.h" /// 以前引入过，现在虽然不用了，但懒得删`<br>`#include "third_party/super_big_lib.h"  /// 暴露一个巨大的库给别人`<br>`#include "for_convenience.h"  /// 有很多用了 abc.h 的也需要这个，直接加在这里多方便`<br><br>class ABC {<br><br>private:<br><br>A a;<br><br>}; | `#program once`<br><br>`#include "a.h"`<br><br>class ABC {<br><br>private:<br><br>A a;<br><br>}; |

### 原则 2. 不要在头文件中写代码(模板除外)

| **BAD**                                                                                                                                                                                   | **GOOD**                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `#program once`<br><br>`#include "a.h"` <br><br>class ABC {<br><br>public:<br><br>   // 懒得找.cc 文件，写在这里多方便<br><br>   void Init() { /// 此处省去一万行  }<br><br>private:<br><br>   A a;<br><br>}; | `#program once`<br><br>`#include "a.h"`<br><br>class ABC {<br><br>public:<br><br>   void Init();<br><br>private:<br><br>   A a;<br><br>}; |

### 原则3. 尽可能不引入额外的头文件(前置声明)

| **BAD**                                                                                                                                                                                                                                                  | **GOOD**                                                                                                                                                                                                                                                                                                                    |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `#program once`<br><br>`#include "a.h"` <br><br>`#include "b.h" // 当 B 只是指针或者引用时，只要前置申明即可`<br><br>class ABC {<br><br>public:<br><br>   void Init() { /// 此处省去一万行  }<br><br>private:<br><br>   A a;<br><br>   `std::unique_ptr<B> b = nullptr;`<br><br>}; | `#program once`<br><br>`#include "a.h"`<br><br>class B;<br><br>class ABC {<br><br>public:<br><br>   void Init();<br><br>   void SetB(const B& b);<br><br>private:<br><br>   A a;<br><br>   `std::unique_ptr<B> b; // 智能指针不需要初始化`<br><br>   `/// std::unique_ptr<B> b = nullptr; 多此一举的写法，不要这样写，因为需要 B 的析构函数支持模板展开`<br><br>}; |

### 原则4. 不要在头文件中使用 using namespace

| **BAD**                                                                                                                                                                                                                                                                                         | **GOOD**                                                                                                                                                                                                                               |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `#program once`<br><br>`#include "a.h"` <br><br>`#include "b.h" // 当 B 只是指针或者引用时，只要前置申明即可`<br><br>using namespace aaa::bb; // 泼脏水<br><br>class ABC {<br><br>public:<br><br>   void Init() { /// 此处省去一万行  }<br><br>private:<br><br>   A a;<br><br>   `std::unique_ptr<B> b = nullptr;`<br><br>}; | `#program once`<br><br>`#include "a.h"`<br><br>class B;<br><br>class ABC {<br><br>public:<br><br>   void Init();<br><br>private:<br><br>   A a;<br><br>   `std::unique_ptr<B> b; // 智能指针不需要初始化，反而=nullptr 会需要析构方法，导致前置申明不可用`<br><br>}; |
``
### 原则5. 如果可以，推荐Impl模式

| **BAD**                                                                                                                                                                                                                                                                                         | **GOOD**                                                                                                                                                                                                                                                                                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `#program once`<br><br>`#include "a.h"` <br><br>`#include "b.h" // 当 B 只是指针或者引用时，只要前置申明即可`<br><br>using namespace aaa::bb; // 泼脏水<br><br>class ABC {<br><br>public:<br><br>   void Init() { /// 此处省去一万行  }<br><br>private:<br><br>   A a;<br><br>   `std::unique_ptr<B> b = nullptr;`<br><br>}; | `#program once`<br><br>class ABC {<br><br>public:<br><br>   void Init();<br><br>private:<br><br>   struct Impl;<br><br>   `std::unique_ptr<Impl> impl_;`<br><br>};<br><br>---<br><br>`#include "abc.h"`<br><br>`#include "a.h"`<br><br>`#include "b.h"`<br><br>struct ABC::Impl {<br><br>   A a;<br><br>   B b;<br><br>};<br><br>void ABC::Init() {<br><br>    impl_ = std::make_unique<Impl>();<br><br>} |
